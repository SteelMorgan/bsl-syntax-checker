# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫

## üéØ –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ Grafana?

**Prometheus** ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–µ—Ç—Ä–∏–∫ (—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –º–∞—à–∏–Ω–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è).  
**Grafana** ‚Äî —ç—Ç–æ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–æ–≤.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫

```powershell
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
$env:GITHUB_TOKEN = (Get-Content '.secrets\github_token.txt' -Raw).Trim()

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d
```

### 2. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: **http://localhost:3000**

**–õ–æ–≥–∏–Ω:** `admin`  
**–ü–∞—Ä–æ–ª—å:** `admin` (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —Å–º–µ–Ω–∏—Ç—å)

---

## üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `docker-compose` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:

### 1. **Loki** (–¥–ª—è –ª–æ–≥–æ–≤)
- **URL:** http://loki:3100
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 2. **Prometheus** (–¥–ª—è –º–µ—Ç—Ä–∏–∫)
- **URL:** http://prometheus:9090
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫ (–∑–∞–ø—Ä–æ—Å—ã, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏)

---

## üîç –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ Loki

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Explore** (–∏–∫–æ–Ω–∫–∞ –∫–æ–º–ø–∞—Å–∞ —Å–ª–µ–≤–∞)
2. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ **Loki**
3. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å:

```logql
{app="mcp-bsl-server"}
```

**–§–∏–ª—å—Ç—Ä—ã:**
- –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏: `{app="mcp-bsl-server"} |= "ERROR"`
- –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `Last 1 hour` –≤–≤–µ—Ä—Ö—É
- –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞: `{app="mcp-bsl-server"} |= "BslCliService"`

### –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫ –≤ Prometheus

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Explore**
2. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ **Prometheus**
3. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å:

```promql
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
http_server_requests_seconds_count

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ JVM
jvm_memory_used_bytes

# –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
rate(http_server_requests_seconds_sum[5m])
```

---

## üìà –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–æ–≤

### –ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è Spring Boot

1. –ù–∞–∂–º–∏—Ç–µ **+** ‚Üí **Import Dashboard**
2. –í–≤–µ–¥–∏—Ç–µ ID: `11378` (Spring Boot 2.1 System Monitor)
3. –ù–∞–∂–º–∏—Ç–µ **Load**
4. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö **Prometheus**
5. –ù–∞–∂–º–∏—Ç–µ **Import**

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞

1. –ù–∞–∂–º–∏—Ç–µ **+** ‚Üí **Dashboard**
2. **Add visualization**
3. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (Loki –∏–ª–∏ Prometheus)
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–ø—Ä–æ—Å
5. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–≥—Ä–∞—Ñ–∏–∫, —Ç–∞–±–ª–∏—Ü–∞, –∫–∞–ª–∏–±—Ä)
6. **Save**

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã

### –î–ª—è Spring Boot –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:

| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----|----------|----------|
| 11378 | Spring Boot 2.1 System Monitor | JVM, HTTP, DB –º–µ—Ç—Ä–∏–∫–∏ |
| 4701 | JVM (Micrometer) | –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ JVM |
| 13639 | Spring Boot Logback Logs | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ |

---

## üé® –ü–∞–Ω–µ–ª–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ MCP BSL Server

### 1. HTTP Requests Rate
```promql
rate(http_server_requests_seconds_count{uri="/api/analyze"}[5m])
```

### 2. Average Response Time
```promql
rate(http_server_requests_seconds_sum[5m]) / rate(http_server_requests_seconds_count[5m])
```

### 3. Error Rate
```promql
rate(http_server_requests_seconds_count{status=~"5.."}[5m])
```

### 4. Active Sessions
```promql
bsl_sessions_active
```

### 5. Memory Usage
```promql
jvm_memory_used_bytes{area="heap"}
```

---

## üêõ –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º —á–µ—Ä–µ–∑ –ª–æ–≥–∏

### –ù–∞–π—Ç–∏ –æ—à–∏–±–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:
```logql
{app="mcp-bsl-server"} |= "ERROR" | json
```

### –ù–∞–π—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
```logql
{app="mcp-bsl-server"} |~ "took [0-9]{4,}ms"
```

### –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ endpoint:
```logql
{app="mcp-bsl-server"} |= "/api/analyze"
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

### 1. –°–æ–∑–¥–∞–π—Ç–µ Alert Rule

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Alerting** ‚Üí **Alert rules**
2. **New alert rule**
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É—Å–ª–æ–≤–∏–µ:
   ```promql
   rate(http_server_requests_seconds_count{status=~"5.."}[5m]) > 0.1
   ```
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ—Ä–æ–≥ –∏ –¥–µ–π—Å—Ç–≤–∏—è

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. **Alerting** ‚Üí **Contact points**
2. **New contact point**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø (Email, Slack, Telegram)
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

---

## üìç –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Grafana Documentation](https://grafana.com/docs/)
- [Loki Query Language](https://grafana.com/docs/loki/latest/logql/)
- [Prometheus Query Language](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Spring Boot Actuator Metrics](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.metrics)

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Grafana —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤:
- `grafana/provisioning/datasources/` ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- `grafana/provisioning/dashboards/` ‚Äî –¥–∞—à–±–æ—Ä–¥—ã

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```powershell
docker-compose restart grafana
```

---

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** –û–∫—Ç—è–±—Ä—å 2024

